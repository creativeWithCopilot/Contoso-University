@page "/enrollment-form/{EnrollmentID:int?}"
@inject EnrollmentService EnrollmentService
@inject StudentService StudentService
@inject CourseService CourseService
@using UniversityFrontend.DTOs
@using UniversityFrontend.Services
<!-- Heading changes depending on whether we are editing or adding an enrollment -->
<h3>@(EnrollmentID.HasValue ? "Edit Enrollment" : "Add Enrollment")</h3>
<!-- EditForm binds to the enrollment model and calls HandleValidSubmit --> 
<EditForm Model="enrollment" OnValidSubmit="HandleValidSubmit"> 
    <DataAnnotationsValidator /> 
    <ValidationSummary />
    <!-- Table layout for form fields -->
    <table class="form-table">
        <tr>
            <td><label>Student:</label></td>
            <td>
                <!-- Dropdown list of students -->
                <!-- Disabled when editing an existing enrollment to prevent changing student -->
                <InputSelect @bind-Value="enrollment.StudentID" disabled="@EnrollmentID.HasValue">
                    <option value="0">-- Select Student --</option>
                    @foreach (var s in students)
                    {
                        <option value="@s.StudentID">@s.FirstMidName @s.LastName</option>
                    }
                </InputSelect>
            </td>
        </tr>
        <tr>
            <td><label>Course:</label></td>
            <td>
                <!-- Dropdown list of courses -->
                <!-- Disabled when editing an existing enrollment to prevent changing course -->
                <InputSelect @bind-Value="enrollment.CourseID" disabled="@EnrollmentID.HasValue">
                    <option value="0">-- Select Course --</option>
                    @foreach (var c in courses)
                    {
                        <option value="@c.CourseID">@c.Title</option>
                    }
                </InputSelect>
            </td>
        </tr>
        <tr>
            <td><label>Grade:</label></td>
            <td>
                <!-- Dropdown list of grades -->
                <InputSelect @bind-Value="enrollment.Grade">
                    <option value="">-- Select Grade --</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="F">F</option>
                </InputSelect>
            </td>
        </tr>
        <tr>
            <td colspan="2" style="text-align:right;">
                <button type="submit" class="btn btn-primary">Save</button> <!-- Save button aligned to the right -->
            </td>
        </tr>
    </table>
</EditForm>
<!-- Display success or error message after add/update -->
@if (message != null) 
{
    <p>@message</p>
}

@code {
    [Parameter] public int? EnrollmentID { get; set; } // Optional parameter: if present, we are editing an existing enrollment
    private EnrollmentCreateDto enrollment = new(); // Model bound to the form inputs, used for both creating and updating enrollments
    private List<StudentDto> students = new(); // List of students to populate the student dropdown
    private List<CourseDto> courses = new(); // List of courses to populate the course dropdown
    private string? message; // Holds success or feedback messages

    protected override async Task OnInitializedAsync() // Lifecycle method called when the component is initialized.
    {
        // Fetch the list of students and courses from the backend API to populate the dropdowns.
        students = await StudentService.GetStudentsAsync();
        courses = await CourseService.GetCoursesAsync();

        if (EnrollmentID.HasValue) 
        {
            var existing = await EnrollmentService.GetEnrollmentAsync(EnrollmentID.Value); // Fetch the existing enrollment details by ID using EnrollmentService
            if (existing != null) // If the enrollment exists, we populate the form model with its details for editing.
            {
                enrollment = new EnrollmentCreateDto
                {
                    StudentID = existing.StudentID,
                    CourseID = existing.CourseID,
                    Grade = existing.Grade
                };
            }
        }
    }

    private async Task HandleValidSubmit() // Handles form submission for both adding and updating enrollments.
    {
        if (enrollment.StudentID == 0 || enrollment.CourseID == 0) // Validate that both a student and a course have been selected before allowing submission.
        {
            message = "Please select both a student and a course.";
            return;
        }

        if (!EnrollmentID.HasValue) // If EnrollmentID is not provided, we are adding a new enrollment, so we call the AddEnrollmentAsync method of EnrollmentService.
        {
            await EnrollmentService.AddEnrollmentAsync(enrollment); // Call the service to add the new enrollment with the details from the form model.
            message = "Enrollment added successfully!";
        }
        else // If EnrollmentID is provided, we are updating an existing enrollment, so we create an EnrollmentUpdateDto and call the UpdateEnrollmentAsync method.
        {
            var updateDto = new EnrollmentUpdateDto
            {
                EnrollmentID = EnrollmentID.Value,
                StudentID = enrollment.StudentID,
                CourseID = enrollment.CourseID,
                Grade = enrollment.Grade
            };
            await EnrollmentService.UpdateEnrollmentAsync(updateDto); // Call the service to update the existing enrollment with the new details from the form model.
            message = "Enrollment updated successfully!";
        }
    }
}
