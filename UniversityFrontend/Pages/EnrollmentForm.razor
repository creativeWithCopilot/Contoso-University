@page "/enrollment-form/{EnrollmentID:int?}"
@inject EnrollmentService EnrollmentService
@inject StudentService StudentService
@inject CourseService CourseService
@using UniversityFrontend.DTOs
@using UniversityFrontend.Services

<h3>@(EnrollmentID.HasValue ? "Edit Enrollment" : "Add Enrollment")</h3>

<table class="form-table">
    <tr>
        <td><label>Student:</label></td>
        <td>
            <InputSelect @bind-Value="enrollment.StudentID" disabled="@EnrollmentID.HasValue">
                <option value="0">-- Select Student --</option>
                @foreach (var s in students)
                {
                    <option value="@s.StudentID">@s.FirstMidName @s.LastName</option>
                }
            </InputSelect>
        </td>
    </tr>
    <tr>
        <td><label>Course:</label></td>
        <td>
            <InputSelect @bind-Value="enrollment.CourseID" disabled="@EnrollmentID.HasValue">
                <option value="0">-- Select Course --</option>
                @foreach (var c in courses)
                {
                    <option value="@c.CourseID">@c.Title</option>
                }
            </InputSelect>
        </td>
    </tr>
    <tr>
        <td><label>Grade:</label></td>
        <td>
            <InputSelect @bind-Value="enrollment.Grade">
                <option value="">-- Select Grade --</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="F">F</option>
            </InputSelect>
        </td>
    </tr>
    <tr>
        <td colspan="2" style="text-align:right;">
            <button type="submit" class="btn btn-primary">Save</button>
        </td>
    </tr>
</table>

@if (message != null)
{
    <p>@message</p>
}

@code {
    [Parameter] public int? EnrollmentID { get; set; }
    private EnrollmentCreateDto enrollment = new();
    private List<StudentDto> students = new();
    private List<CourseDto> courses = new();
    private string? message;

    protected override async Task OnInitializedAsync()
    {
        students = await StudentService.GetStudentsAsync();
        courses = await CourseService.GetCoursesAsync();

        if (EnrollmentID.HasValue)
        {
            var existing = await EnrollmentService.GetEnrollmentAsync(EnrollmentID.Value);
            if (existing != null)
            {
                enrollment = new EnrollmentCreateDto
                {
                    StudentID = existing.StudentID,
                    CourseID = existing.CourseID,
                    Grade = existing.Grade
                };
            }
        }
    }

    private async Task HandleValidSubmit()
    {
        if (enrollment.StudentID == 0 || enrollment.CourseID == 0)
        {
            message = "Please select both a student and a course.";
            return;
        }

        if (!EnrollmentID.HasValue)
        {
            await EnrollmentService.AddEnrollmentAsync(enrollment);
            message = "Enrollment added successfully!";
        }
        else
        {
            var updateDto = new EnrollmentUpdateDto
            {
                EnrollmentID = EnrollmentID.Value,
                StudentID = enrollment.StudentID,
                CourseID = enrollment.CourseID,
                Grade = enrollment.Grade
            };
            await EnrollmentService.UpdateEnrollmentAsync(updateDto);
            message = "Enrollment updated successfully!";
        }
    }
}
